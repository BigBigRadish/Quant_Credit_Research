clear

%Set preferences with setdbprefs.
setdbprefs('DataReturnFormat', 'dataset');
% setdbprefs('DataReturnFormat','structure');
setdbprefs('NullNumberRead', 'NaN');
setdbprefs('NullStringRead', 'null');




%Make connection to database.  Note that the password has been omitted.
%Using JDBC driver.
conn = database('Xpressfeed', '', '', 'Vendor', 'MICROSOFT SQL SERVER', 'Server', 'GFISQL', 'PortNumber', 1433, 'AuthType', 'Windows');

% sqlquery = ['declare @combo nvarchar(255) = ''68'' ' ...
%     'declare @date date = ''2013-04-30'' ' ...
%     'SELECT * ' ...
%     'into #MkyHoldings ' ...
%     'FROM dbo.ftn_get_MkyCombo_CorpHoldings(@date, @combo)' ...
%     'create table #companyUltimateParent_tbl (companyid int, companyName varchar(100), ultimateParentId int, level int) '...
%     'insert into #companyUltimateParent_tbl (companyid, companyName, ultimateParentId, level) ' ...
%     'select c.companyId, c.companyName,c.companyId as ultimateParentId, convert(tinyint, 0) as level ' ...
%     'from ciqCompany c with (nolock) ' ...
% 	'where c.companyId IN (select distinct c.companyId ' ...
%     'from #MkyHoldings a '...
%     'join ciqSymbol sym on a.isin = sym.symbolValue ' ...
%     'join ciqSecurity sec on sym.objectId = sec.securityId ' ...
%     'join ciqCompany c on sec.companyId = c.companyId ' ...
%     ') ' ...
%     'declare @level tinyint ' ...
%     'set @level = 1 ' ...
%     'while @level <= 10 ' ...
%     'begin ' ...
%     'update up ' ...
%     'set ultimateParentId = cr.companyId ' ...
%     ',level = @level ' ...
%     'from #companyUltimateParent_tbl up (tablockx) ' ...
%     'inner join ciqCompanyRel cr (nolock) ' ...
%     'on up.ultimateParentId = cr.companyId2 ' ...
%     ' and cr.companyRelTypeId in (5,7,9,17,40) ' ...
%     ' set @level = @level +1 ' ...
%     'end ' ...
%     'SELECT * ' ...
%     'FROM #companyUltimateParent_tbl ' ];


% sqlquery3 =  ['exec sp_get_MkyCombo_CorpHoldings_Analytics ' '''' idxName '''' ',' '''' date '''' ',' '''' combo '''' ];
% sqlquery3 = ['exec sp_Idx_Test ''H0A0'''];
% sqlquery = ['exec sp_Idx_Test_noparam'];
sqlquery3 = ['exec sp_get_Idx_Holdings_Analytics ''H0A0''' ',' '''2013-04-30'',' '0']
% test = ['exec sp_get_MkyCombo_CorpHoldings_CompanyIds_Metrics_noparam'];
% sqlquery2 = ['exec sp_get_MkyCombo_CorpHoldings_CompanyIds_Metrics ' '''' year '''' ',' '''' quarter '''' ',' '''' combo '''' ',' '''' date '''' ...
%             ',' '''' exclusive '''' ',' '''' ultimate ''''];
% 
% sqlquery1 =  ['exec sp_get_Idx_Holdings_Analytics ' '''' idxName '''' ',' '''' date '''' ',' '''' faceValMin '''' ];
% sqlquery4 = ['exec sp_get_Idx_Holdings_CompanyIds_Metrics '  '''' year '''' ',' '''' quarter '''' ',' '''' idxName '''' ',' '''' date '''' ',' '''' faceValMin '''' ...
%             ',' '''' exclusive '''' ',' '''' ultimate ''''];



 curs = exec(conn,sqlquery3);  %use sqlquery, sqlquery2, or sqlquery3 depending on the command you want to execute.



curs = fetch(curs);
close(curs);

%Assign data to output variable
untitled = curs.Data;


%Close database connection.
close(conn);

%Clear variables
clear curs conn